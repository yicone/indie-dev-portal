generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Repo {
  id               Int            @id @default(autoincrement())
  name             String
  slug             String         @unique
  description      String?
  repoPath         String
  primaryLanguage  String
  frameworks       String
  ciStatus         String         @default("pending")
  lastOpenedAt     DateTime?
  notes            String?
  stars            Int            @default(0)
  updatedAt        DateTime       @updatedAt
  createdAt        DateTime       @default(now())
  commits          Commit[]
  agentSessions    AgentSession[]
}

model Commit {
  id          Int      @id @default(autoincrement())
  hash        String
  message     String
  author      String
  committedAt DateTime
  repo        Repo     @relation(fields: [repoId], references: [id], onDelete: Cascade)
  repoId      Int

  @@index([repoId])
  @@index([committedAt])
}

model AgentSession {
  id              String         @id @default(uuid())
  repoId          Int
  repo            Repo           @relation(fields: [repoId], references: [id], onDelete: Cascade)
  status          String         // 'active', 'suspended', 'completed', 'cancelled', 'error'
  agentType       String         @default("gemini-cli") // 'gemini-cli', 'codex-cli', 'claude-code'
  agentVersion    String         @default("0.11.3")
  supportsResume  Boolean        @default(false) // Agent capability flag
  resumeData      String?        // JSON-serialized resume data
  lastActiveAt    DateTime       @default(now()) // For cleanup
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  messages        AgentMessage[]

  @@index([repoId])
  @@index([status])
  @@index([updatedAt])
  @@index([lastActiveAt])
}

model AgentMessage {
  id        String       @id @default(uuid())
  sessionId String
  session   AgentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role      String       // 'user', 'agent', 'system'
  content   String       // JSON-serialized message content
  timestamp DateTime     @default(now())

  @@index([sessionId])
  @@index([timestamp])
}
