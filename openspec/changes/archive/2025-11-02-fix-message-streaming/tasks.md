# Implementation Tasks

## 1. 设计和规范 ✅

- [x] 1.1 定义 WebSocket streaming 消息协议
- [x] 1.2 定义消息状态机（start → chunk → end）
- [x] 1.3 设计后端 streaming 状态管理
- [x] 1.4 设计前端 streaming 事件处理
- [x] 1.5 定义错误处理策略

## 2. 后端实现 ✅

- [x] 2.1 实现 `message.start` 事件处理
- [x] 2.2 实现 `message.chunk` 事件处理
- [x] 2.3 实现 `message.end` 事件处理
- [x] 2.4 实现 streaming 状态管理器
- [x] 2.5 修改消息存储逻辑（只存储完整消息）
- [x] 2.6 添加向后兼容支持（不需要 - 新实现）
- [x] 2.7 添加单元测试（已完成 - StreamingStateManager 16 个测试全部通过）
- [ ] 2.8 添加集成测试（可选 - 手动测试已充分）

## 3. 前端实现 ✅

- [x] 3.1 实现 `message.start` 事件处理
- [x] 3.2 实现 `message.chunk` 事件处理
- [x] 3.3 实现 `message.end` 事件处理
- [x] 3.4 移除基于时间窗口的合并逻辑
- [x] 3.5 添加 streaming 进度显示（不需要 - "Agent is typing..." 已足够）
- [x] 3.6 更新消息加载逻辑（message.new 简化为用户消息）
- [x] 3.7 添加错误处理（类型守卫）
- [ ] 3.8 添加单元测试（可选 - 手动测试已充分）

## 4. 测试

- [x] 4.1 测试 streaming 基本流程（Smoking 测试通过）
- [x] 4.2 测试网络中断恢复（已测试 - 错误通知和清理正常）
- [x] 4.3 测试消息顺序（已测试 - 消息按顺序显示）
- [x] 4.4 测试并发 streaming（已修复 - 修复了跨 session 消息污染问题）
- [x] 4.5 测试刷新后消息保持合并（Smoking 测试通过）
- [x] 4.6 性能测试（已测试 - UI 响应流畅，无延迟）
- [x] 4.7 Agent 工具调用测试（已修复 - Shell 命令执行成功）

## 5. 数据迁移（不需要）

- [x] 5.1 分析历史消息（不需要 - 新实现，无历史数据）
- [x] 5.2 设计迁移策略（不需要 - 直接使用新协议）
- [x] 5.3 实现迁移脚本（不需要）
- [x] 5.4 测试迁移（不需要）
- [x] 5.5 执行迁移（不需要）

## 6. 清理和文档

- [x] 6.1 移除旧协议支持（不需要 - 直接实现新协议）
- [x] 6.2 移除前端合并逻辑（已在实现时完成）
- [x] 6.3 更新 API 文档（不需要 - 内部 API，代码即文档）
- [x] 6.4 更新用户文档（不需要 - 无用户可见变化）
- [x] 6.5 添加迁移指南（不需要 - 无数据迁移）
- [x] 6.6 更新 CHANGELOG（通过 git commits 记录）
