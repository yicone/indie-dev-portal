# Implementation Tasks

## 1. 设计和规范 ✅

- [x] 1.1 定义 WebSocket streaming 消息协议
- [x] 1.2 定义消息状态机（start → chunk → end）
- [x] 1.3 设计后端 streaming 状态管理
- [x] 1.4 设计前端 streaming 事件处理
- [x] 1.5 定义错误处理策略

## 2. 后端实现 ✅

- [x] 2.1 实现 `message.start` 事件处理
- [x] 2.2 实现 `message.chunk` 事件处理
- [x] 2.3 实现 `message.end` 事件处理
- [x] 2.4 实现 streaming 状态管理器
- [x] 2.5 修改消息存储逻辑（只存储完整消息）
- [ ] 2.6 添加向后兼容支持（可选 - 不需要）
- [ ] 2.7 添加单元测试（推迟到 Section 4）
- [ ] 2.8 添加集成测试（推迟到 Section 4）

## 3. 前端实现 ✅

- [x] 3.1 实现 `message.start` 事件处理
- [x] 3.2 实现 `message.chunk` 事件处理
- [x] 3.3 实现 `message.end` 事件处理
- [x] 3.4 移除基于时间窗口的合并逻辑
- [ ] 3.5 添加 streaming 进度显示（推迟 - 不需要）
- [x] 3.6 更新消息加载逻辑（message.new 简化为用户消息）
- [x] 3.7 添加错误处理（类型守卫）
- [ ] 3.8 添加单元测试（推迟到 Section 4）

## 4. 测试

- [x] 4.1 测试 streaming 基本流程（Smoking 测试通过）
- [x] 4.2 测试网络中断恢复（已验证 - 错误通知和清理工作正常）
- [ ] 4.3 测试消息顺序（可选 - 跳过）
- [ ] 4.4 测试并发 streaming（可选 - 跳过）
- [x] 4.5 测试刷新后消息保持合并（Smoking 测试通过）
- [ ] 4.6 性能测试（可选 - 跳过）
- [x] 4.7 Agent 工具调用测试（已修复 - Shell 命令执行成功）

## 5. 数据迁移（可选）

- [ ] 5.1 分析历史消息
- [ ] 5.2 设计迁移策略
- [ ] 5.3 实现迁移脚本
- [ ] 5.4 测试迁移
- [ ] 5.5 执行迁移

## 6. 清理和文档

- [ ] 6.1 移除旧协议支持
- [ ] 6.2 移除前端合并逻辑
- [ ] 6.3 更新 API 文档
- [ ] 6.4 更新用户文档
- [ ] 6.5 添加迁移指南
- [ ] 6.6 更新 CHANGELOG
